<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Peta Hotspot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #passwordOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #passwordInput {
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="passwordOverlay">
    <input type="password" id="passwordInput" placeholder="Masukkan Password" />
    <button onclick="checkPassword()">Masuk</button>
  </div>

  <div id="map"></div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSZJcDHPVAlfa8eOV_A8OjXPCvRSokL9_M4bwOD2Kxu7LWNISZ3GfPtMMe4mrl1J0Q/pub?gid=0&single=true&output=csv';
    let map, hotspotLayer, geojsonLayer;

    function checkPassword() {
      const password = document.getElementById('passwordInput').value;
      if (password === 'karla') {
        document.getElementById('passwordOverlay').style.display = 'none';
        init();
      } else {
        alert('Password salah!');
      }
    }

    function init() {
      map = L.map('map').setView([-2.5, 117], 5);

      // Peta dasar
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Layer batas provinsi (duluan supaya di bawah hotspot)
      loadProvinsiGeoJSON();

      // Layer hotspot
      fetchAndRenderData();
    }

    function fetchAndRenderData() {
      fetch(sheetUrl)
        .then(response => response.text())
        .then(csvText => {
          const rows = csvText.trim().split('\n').slice(1);
          const data = rows.map(row => {
            const cols = row.split(',');
            return {
              tanggal: cols[1],
              jam: cols[2],
              provinsi: cols[3],
              kabkota: cols[4],
              kecamatan: cols[5],
              desa: cols[6],
              lat: parseFloat(cols[7]),
              lon: parseFloat(cols[8]),
              confidence: cols[9],
              sumber: cols[10]
            };
          });

          if (hotspotLayer) map.removeLayer(hotspotLayer);

          hotspotLayer = L.layerGroup();

          data.forEach(d => {
            if (isNaN(d.lat) || isNaN(d.lon)) return;

            const color = d.confidence.toLowerCase() === 'high' ? 'red' : 'yellow';

            const circle = L.circleMarker([d.lat, d.lon], {
              radius: 6,
              fillColor: color,
              color: color,
              weight: 1,
              opacity: 0.5,
              fillOpacity: 0.5
            }).bindPopup(
              `<b>Tanggal:</b> ${d.tanggal}<br/>
               <b>Jam:</b> ${d.jam}<br/>
               <b>Provinsi:</b> ${d.provinsi}<br/>
               <b>Kab/Kota:</b> ${d.kabkota}<br/>
               <b>Kecamatan:</b> ${d.kecamatan}<br/>
               <b>Desa:</b> ${d.desa}<br/>
               <b>Confidence:</b> ${d.confidence}<br/>
               <b>Sumber:</b> ${d.sumber}`
            );
            hotspotLayer.addLayer(circle);
          });

          hotspotLayer.addTo(map);
        })
        .catch(err => console.error('Gagal memuat data:', err));
    }

    function loadProvinsiGeoJSON() {
      fetch("provinsi.geojson")
        .then(response => response.json())
        .then(geojson => {
          if (geojsonLayer) map.removeLayer(geojsonLayer);
          geojsonLayer = L.geoJSON(geojson, {
            style: {
              color: "#000000", // Garis hitam
              weight: 1,
              fillOpacity: 0    // Isi transparan total
            }
          }).addTo(map);
        })
        .catch(err => console.error("Gagal memuat provinsi.geojson", err));
    }
  </script>
</body>
</html>

<script>
  const map = L.map('map', { attributionControl: false }).setView([-2.5, 117], 5);
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 18
  }).addTo(map);

  const hotspotLayer = L.layerGroup().addTo(map);
  let geojsonLayer = null;

  const url = "https://opensheet.elk.sh/1Vce5YUId7cUZ29j8OEhdFSer26cszXgX3OSm5zoX1UI/Data%20Hotspot%20Nasional";
  const geojsonURL = "https://drive.google.com/uc?export=download&id=1FakxI_u6NMDfElXKytZZ4JoCLFFD4dFj";
  let rawData = [];

  function getLastThreeDates() {
    const options = { day: '2-digit', month: 'long', year: 'numeric' };
    const result = [];
    for (let i = 0; i < 3; i++) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      result.push(date.toLocaleDateString('id-ID', options));
    }
    return result;
  }

  function extractTanggal(tanggalJam) {
    const parts = tanggalJam.split(',')[1]?.trim().split(' ') || [];
    return parts.slice(0, 3).join(' ');
  }

  function renderFilterTanggal() {
    const div = document.getElementById("tanggal-filter");
    const list = getLastThreeDates();
    div.innerHTML = "";
    list.forEach(tgl => {
      div.innerHTML += `<label><input type="checkbox" class="tanggal-filter" value="${tgl}" checked> ${tgl}</label>`;
    });
  }

  function renderFilterSumber(data) {
    const sumberSet = new Set();
    data.forEach(row => {
      if (row.Sumber) sumberSet.add(row.Sumber.trim());
    });
    const div = document.getElementById("sumber-filter");
    div.innerHTML = "";
    Array.from(sumberSet).sort().forEach(src => {
      div.innerHTML += `<label><input type="checkbox" class="sumber-filter" value="${src}" checked> ${src}</label>`;
    });
  }

  function getSelectedFilters() {
    const levels = [...document.querySelectorAll('.confidence-filter:checked')].map(cb => cb.value);
    const tanggal = [...document.querySelectorAll('.tanggal-filter:checked')].map(cb => cb.value);
    const sumber = [...document.querySelectorAll('.sumber-filter:checked')].map(cb => cb.value);
    return { levels, tanggal, sumber };
  }

  function applyFilters() {
    const { levels, tanggal, sumber } = getSelectedFilters();
    hotspotLayer.clearLayers();

    rawData.forEach(row => {
      const lat = parseFloat(row.Latitude);
      const lon = parseFloat(row.Longitude);
      const conf = row.Confidence_Level?.toLowerCase();
      const waktu = row["Tanggal & Jam"] || "";
      const tanggalOnly = extractTanggal(waktu);
      const lokasi = `${row.Provinsi} - ${row["Kab/Kota"]}`;
      const kecamatan = row.Kecamatan || "";
      const desa = row.Desa || "";
      const sumberVal = row.Sumber?.trim() || "";

      if (!isNaN(lat) && !isNaN(lon) &&
          levels.includes(conf) &&
          tanggal.includes(tanggalOnly) &&
          sumber.includes(sumberVal)) {

        const color = conf === 'high' ? 'red' : 'yellow';

        L.circleMarker([lat, lon], {
          radius: 6,
          fillColor: color,
          color: '#000',
          weight: 1,
          opacity: 0.5,
          fillOpacity: 0.5
        }).addTo(hotspotLayer).bindPopup(`
          <b>${waktu}</b><br>
          ${lokasi}<br>
          Kecamatan: ${kecamatan}<br>
          Desa: ${desa}<br>
          Confidence: ${conf}<br>
          Sumber: ${sumberVal}<br>
          Koordinat: ${lat.toFixed(4)}, ${lon.toFixed(4)}
        `);
      }
    });
  }

  function fetchAndRenderData() {
    fetch(url)
      .then(res => res.json())
      .then(data => {
        rawData = data;
        renderFilterTanggal();
        renderFilterSumber(data);
        applyFilters();
        document.querySelectorAll('.filters input[type=checkbox]').forEach(cb => {
          cb.addEventListener('change', applyFilters);
        });
      });
  }

  function loadGeoJSON() {
    fetch(geojsonURL)
      .then(res => res.json())
      .then(geojson => {
        if (geojsonLayer) map.removeLayer(geojsonLayer);
        geojsonLayer = L.geoJSON(geojson, {
          style: {
            color: "#000",
            weight: 1,
            fillColor: "#ccc",
            fillOpacity: 0.1
          }
        }).addTo(map);
      });
  }

  function exportTable(format) {
    const { levels, tanggal, sumber } = getSelectedFilters();
    const filtered = rawData.filter(row => {
      const conf = row.Confidence_Level?.toLowerCase();
      const tgl = extractTanggal(row["Tanggal & Jam"] || "");
      const sumberVal = row.Sumber?.trim() || "";
      return levels.includes(conf) && tanggal.includes(tgl) && sumber.includes(sumberVal);
    });

    if (format === 'csv' || format === 'xlsx') {
      const ws = XLSX.utils.json_to_sheet(filtered);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Hotspot");
      XLSX.writeFile(wb, `hotspot.${format}`);
    } else if (format === 'pdf') {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const table = filtered.map(r => [
        r["Tanggal & Jam"] || "", r.Provinsi, r["Kab/Kota"], r.Kecamatan, r.Desa,
        r.Latitude, r.Longitude, r.Confidence_Level, r.Sumber
      ]);
      doc.autoTable({
        head: [['Tanggal & Jam', 'Provinsi', 'Kab/Kota', 'Kecamatan', 'Desa', 'Lat', 'Lng', 'Confidence', 'Sumber']],
        body: table,
        styles: { fontSize: 8 }
      });
      doc.save("hotspot.pdf");
    }
  }

  // ========== Login dengan localStorage ==========
  function checkPassword() {
    const input = document.getElementById('password-input').value;
    if (input === "karla") {
      localStorage.setItem("hotspot_logged_in", "true");
      document.getElementById('login-overlay').style.display = 'none';
      init();
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  }

  function init() {
    fetchAndRenderData();
    loadGeoJSON();
    setInterval(fetchAndRenderData, 15 * 60 * 1000);
  }

  // Saat halaman dimuat: cek status login
  window.onload = () => {
    const loggedIn = localStorage.getItem("hotspot_logged_in");
    if (loggedIn === "true") {
      document.getElementById('login-overlay').style.display = 'none';
      init();
    }
  };
</script>

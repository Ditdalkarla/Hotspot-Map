<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta Hotspot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #loginOverlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      flex-direction: column;
    }
    #loginOverlay input {
      padding: 10px; margin-top: 10px;
    }
  </style>
</head>
<body>

<div id="loginOverlay">
  <h2>Masukkan Password</h2>
  <input type="password" id="passwordInput" placeholder="Password..." />
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  let map;

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  });

  const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19,
    attribution: 'Tiles Â© Esri'
  });

  function startMap() {
    map = L.map('map', {
      center: [-1.5, 117],
      zoom: 5,
      layers: [osm]
    });

    const baseLayers = {
      "OpenStreetMap": osm,
      "ESRI Satelit": esri
    };
    L.control.layers(baseLayers).addTo(map);

    // Tambahkan GeoJSON provinsi
    fetch('provinsi.geojson')
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          style: { color: '#555', weight: 1, fillOpacity: 0 }
        }).addTo(map);
      });

    fetchHotspots();
    setInterval(fetchHotspots, 15 * 60 * 1000); // setiap 15 menit
  }

  function fetchHotspots() {
    const url = 'https://opensheet.elk.sh/1aV7-rDKs93FuJpvLyZazsQaQVkXFF0n4NH4GvIfvp1g/Data%20Hotspot%20Nasional';
    fetch(url)
      .then(res => res.json())
      .then(data => {
        // Hapus layer lama kalau ada
        if (window.hotspotLayer) {
          map.removeLayer(window.hotspotLayer);
        }

        const features = [];
        data.forEach(row => {
          if (!row['Latitude'] || !row['Longitude']) return;

          const lat = parseFloat(row['Latitude']);
          const lon = parseFloat(row['Longitude']);
          const confidence = row['Confidence_Level'] || '';
          const color = confidence.toLowerCase() === 'high' ? 'red' :
                        confidence.toLowerCase() === 'medium' ? 'orange' : 'gray';

          const circle = L.circleMarker([lat, lon], {
            radius: 6,
            fillColor: color,
            color: color,
            weight: 1,
            opacity: 0.5,
            fillOpacity: 0.5
          });

          const popup = `
            <b>Provinsi:</b> ${row['Provinsi'] || ''}<br/>
            <b>Kab/Kota:</b> ${row['Kab/Kota'] || ''}<br/>
            <b>Kecamatan:</b> ${row['Kecamatan'] || ''}<br/>
            <b>Desa:</b> ${row['Desa'] || ''}<br/>
            <b>Tanggal:</b> ${row['Tanggal'] || ''}<br/>
            <b>Jam:</b> ${row['Jam'] || ''}<br/>
            <b>Confidence:</b> ${row['Confidence_Level'] || ''}<br/>
            <b>Sumber:</b> ${row['Sumber'] || ''}
          `;

          circle.bindPopup(popup);
          features.push(circle);
        });

        window.hotspotLayer = L.layerGroup(features).addTo(map);
      })
      .catch(err => {
        console.error("Gagal fetch hotspot:", err);
      });
  }

  document.getElementById('passwordInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      const input = e.target.value;
      if (input === 'karla') {
        document.getElementById('loginOverlay').style.display = 'none';
        startMap();
      } else {
        alert('Password salah!');
      }
    }
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta Hotspot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    .popup-alert {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border: 2px solid red;
      border-radius: 10px;
      z-index: 9999;
      font-family: sans-serif;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .popup-alert h4 {
      margin: 0 0 5px 0;
      font-size: 16px;
      color: red;
    }
    .popup-alert ul {
      margin: 0;
      padding-left: 20px;
      font-size: 14px;
    }
    .popup-alert ul li {
      cursor: pointer;
      color: blue;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });

    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri'
    });

    const map = L.map('map', {
      center: [-1.5, 117],
      zoom: 5,
      layers: [esri] // default satelit
    });

    const baseLayers = {
      "ðŸ—ºï¸ OpenStreetMap": osm,
      "ðŸ›°ï¸ ESRI Satelit": esri
    };
    L.control.layers(baseLayers).addTo(map);

    let hotspotLayer = L.layerGroup().addTo(map);
    let previousKeys = [];

    function fetchHotspotData() {
      fetch('https://script.google.com/macros/s/AKfycbxVNwMkm61H_e1k-aRgHKvRHtUZLWe1iCImSFWqFke0ZQYYdXq1vhAfXh5P_9y-rmVh/exec')
        .then(response => response.json())
        .then(data => {
          const newMarkers = [];
          hotspotLayer.clearLayers();

          data.forEach(item => {
            const key = `${item.latitude},${item.longitude},${item.date_hotspot}`;
            const isNew = !previousKeys.includes(key);
            if (isNew) previousKeys.push(key);

            const color = item.confidence_level === 'high' ? 'red' : 'yellow';
            const marker = L.circleMarker([item.latitude, item.longitude], {
              radius: 6,
              fillColor: color,
              color: "#000",
              weight: 1,
              opacity: 0.5,
              fillOpacity: 0.5
            }).bindPopup(`
              <b>Provinsi:</b> ${item.nama_provinsi}<br/>
              <b>Kab/Kota:</b> ${item.kabkota}<br/>
              <b>Kecamatan:</b> ${item.kecamatan}<br/>
              <b>Desa:</b> ${item.desa}<br/>
              <b>Waktu:</b> ${item.date_hotspot}<br/>
              <b>Confidence:</b> ${item.confidence_level}<br/>
              <b>Sumber:</b> ${item.sumber}
            `);

            marker.addTo(hotspotLayer);

            if (isNew) {
              newMarkers.push({ marker, item });
            }
          });

          if (newMarkers.length > 0) {
            showPopupAlert(newMarkers);
            playSound();
          }
        })
        .catch(err => {
          console.error("Gagal ambil data hotspot:", err);
        });
    }

    function showPopupAlert(newMarkers) {
      const box = document.createElement('div');
      box.className = 'popup-alert';
      box.innerHTML = `
        <h4>ðŸ”¥ Hotspot Baru Terdeteksi!</h4>
        <ul>${newMarkers.map((d, i) => `<li data-idx="${i}">${d.item.desa}, ${d.item.kabkota}</li>`).join('')}</ul>
      `;
      document.body.appendChild(box);

      box.querySelectorAll('li').forEach(li => {
        li.addEventListener('click', () => {
          const idx = parseInt(li.getAttribute('data-idx'));
          const m = newMarkers[idx].marker;
          map.setView(m.getLatLng(), 12);
          m.openPopup();
        });
      });

      setTimeout(() => box.remove(), 60000);
    }

    function playSound() {
      const audio = new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3");
      audio.play();
    }

    function loadGeoJSON() {
      const url = "https://raw.githubusercontent.com/Ditdalkarla/Hotspot-Map/main/provinsi.geojson";
      fetch(url)
        .then(res => res.json())
        .then(data => {
          L.geoJSON(data, {
            style: {
              color: '#3388ff',
              weight: 1,
              fillOpacity: 0.05
            }
          }).addTo(map);
        })
        .catch(err => console.error("GeoJSON gagal dimuat:", err));
    }

    function init() {
      loadGeoJSON();
      fetchHotspotData();
      setInterval(fetchHotspotData, 15 * 60 * 1000); // setiap 15 menit
    }

    init();
  </script>
</body>
</html>

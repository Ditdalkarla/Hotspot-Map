<script>
  let map;
  let hotspotLayer;

  function initMap() {
    map = L.map('map').setView([-2.5, 117], 5);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri â€” Source: Esri, Earthstar Geographics',
      maxZoom: 18
    }).addTo(map);

    loadHotspotData();
  }

  function loadHotspotData() {
    const url = 'https://opensheet.elk.sh/1Vce5YUId7cUZ29j8OEhdFSer26cszXgX3OSm5zoX1UI/Data Hotspot Nasional';

    fetch(url)
      .then(response => response.json())
      .then(data => {
        console.log("Hotspot data:", data); // debug line

        if (hotspotLayer) {
          map.removeLayer(hotspotLayer);
        }

        const markers = [];

        data.forEach(row => {
          const lat = parseFloat(row.Latitude);
          const lon = parseFloat(row.Longitude);
          const level = row.Confidence_Level?.toLowerCase() || '';
          const sumber = row.Sumber || '';
          const tanggal = row.Tanggal || '';
          const jam = row.Jam || '';

          if (!isNaN(lat) && !isNaN(lon)) {
            const color = (level === 'high') ? 'red' :
                          (level === 'medium') ? 'yellow' : 'gray';

            const marker = L.circleMarker([lat, lon], {
              radius: 6,
              fillColor: color,
              color: '#000',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.5
            }).bindPopup(`
              <b>Tanggal:</b> ${tanggal}<br>
              <b>Jam:</b> ${jam}<br>
              <b>Confidence:</b> ${level}<br>
              <b>Sumber:</b> ${sumber}
            `);

            markers.push(marker);
          }
        });

        hotspotLayer = L.layerGroup(markers).addTo(map);
        map.invalidateSize(); // optional
      });
  }

  // Init
  window.addEventListener('load', () => {
    initMap();
    setInterval(loadHotspotData, 15 * 60 * 1000);
  });
</script>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peta Hotspot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    .popup-alert {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border: 2px solid red;
      border-radius: 10px;
      z-index: 9999;
      font-family: sans-serif;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .popup-alert h4 {
      margin: 0 0 5px 0;
      font-size: 16px;
      color: red;
    }
    .popup-alert ul {
      margin: 0;
      padding-left: 20px;
      font-size: 14px;
    }
    .popup-alert ul li {
      cursor: pointer;
      color: blue;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // Base layers
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    });

    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: 'Tiles Â© Esri'
    });

    // Map init
    const map = L.map('map', {
      center: [-1.5, 117],
      zoom: 5,
      layers: [osm] // default layer
    });

    // Layer control
    const baseLayers = {
      "ðŸ—ºï¸ OpenStreetMap": osm,
      "ðŸ›°ï¸ ESRI Satelit": esri
    };
    L.control.layers(baseLayers).addTo(map);

    let hotspotLayer = L.layerGroup().addTo(map);
    let geojsonLayer;
    let previousData = [];

    function fetchAndRenderData() {
      fetch('https://script.google.com/macros/s/AKfycbxVNwMkm61H_e1k-aRgHKvRHtUZLWe1iCImSFWqFke0ZQYYdXq1vhAfXh5P_9y-rmVh/exec')
        .then(res => res.json())
        .then(data => {
          const newHotspots = [];
          const newMarkers = [];

          data.forEach(item => {
            const key = item.latitude + ',' + item.longitude + ',' + item.date_hotspot;
            if (!previousData.includes(key)) {
              newHotspots.push(item);
              previousData.push(key); // update list
            }

            const iconColor = item.confidence_level === "high" ? "red" : "yellow";
            const icon = L.circleMarker([item.latitude, item.longitude], {
              radius: 6,
              fillColor: iconColor,
              color: "#000",
              weight: 1,
              opacity: 0.5,
              fillOpacity: 0.5
            });

            icon.bindPopup(`
              <b>Provinsi:</b> ${item.nama_provinsi}<br/>
              <b>Kab/Kota:</b> ${item.kabkota}<br/>
              <b>Kecamatan:</b> ${item.kecamatan}<br/>
              <b>Desa:</b> ${item.desa}<br/>
              <b>Waktu:</b> ${item.date_hotspot}<br/>
              <b>Confidence:</b> ${item.confidence_level}<br/>
              <b>Sumber:</b> ${item.sumber}
            `);

            icon.addTo(hotspotLayer);

            if (newHotspots.includes(item)) {
              newMarkers.push({ marker: icon, item });
            }
          });

          if (newMarkers.length > 0) {
            showAlertPopup(newMarkers);
            playNotificationSound();
          }
        });
    }

    function showAlertPopup(newMarkers) {
      const container = document.createElement('div');
      container.className = 'popup-alert';
      container.innerHTML = `
        <h4>ðŸ”¥ Hotspot Baru Terdeteksi!</h4>
        <ul>${newMarkers.map((m, i) => `<li data-idx="${i}">${m.item.desa}, ${m.item.kabkota}</li>`).join('')}</ul>
      `;
      document.body.appendChild(container);

      // Klik lompat ke marker
      container.querySelectorAll('li').forEach(li => {
        li.addEventListener('click', () => {
          const idx = li.getAttribute('data-idx');
          const marker = newMarkers[idx].marker;
          map.setView(marker.getLatLng(), 12);
          marker.openPopup();
        });
      });

      setTimeout(() => {
        container.remove();
      }, 60000); // hilang setelah 60 detik
    }

    function playNotificationSound() {
      const audio = new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3");
      audio.play();
    }

    function init() {
      const geojsonUrl = 'https://raw.githubusercontent.com/Ditdalkarla/Hotspot-Map/main/provinsi.geojson';
      fetch(geojsonUrl)
        .then(res => res.json())
        .then(data => {
          geojsonLayer = L.geoJSON(data, {
            style: {
              color: '#3388ff',
              weight: 1,
              fillOpacity: 0.05
            }
          }).addTo(map);
          fetchAndRenderData();

          // ðŸ” Auto-refresh tiap 15 menit
          setInterval(() => {
            hotspotLayer.clearLayers();
            fetchAndRenderData();
          }, 15 * 60 * 1000);
        })
        .catch(err => {
          console.error("Gagal memuat GeoJSON:", err);
          fetchAndRenderData();

          setInterval(() => {
            hotspotLayer.clearLayers();
            fetchAndRenderData();
          }, 15 * 60 * 1000);
        });
    }

    init();
  </script>
</body>
</html>
